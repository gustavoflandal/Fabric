import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();

async function main() {
  console.log('üîî Iniciando seed de notifica√ß√µes...\n');

  // Buscar usu√°rios existentes
  const users = await prisma.user.findMany({
    take: 5,
  });

  if (users.length === 0) {
    console.log('‚ùå Nenhum usu√°rio encontrado. Execute o seed principal primeiro.');
    return;
  }

  console.log(`‚úÖ ${users.length} usu√°rios encontrados\n`);

  // Buscar algumas ordens de produ√ß√£o para refer√™ncia
  const orders = await prisma.productionOrder.findMany({
    take: 3,
    include: {
      product: true,
    },
  });

  // Buscar alguns produtos para refer√™ncia
  const products = await prisma.product.findMany({
    take: 3,
  });

  // Buscar centros de trabalho
  const workCenters = await prisma.workCenter.findMany({
    take: 2,
  });

  const notifications = [];
  
  console.log('üìù Criando notifica√ß√µes variadas para teste...\n');

  // Para cada usu√°rio, criar notifica√ß√µes variadas
  for (const user of users) {
    // 1. NOTIFICA√á√ÉO CR√çTICA - Material Indispon√≠vel
    if (orders.length > 0) {
      notifications.push({
        userId: user.id,
        type: 'ERROR',
        category: 'PRODUCTION',
        eventType: 'MATERIAL_UNAVAILABLE',
        title: 'Material Indispon√≠vel',
        message: `Material Chip A15 necess√°rio para OP ${orders[0].orderNumber} n√£o est√° dispon√≠vel. Necess√°rio: 100, Dispon√≠vel: 45`,
        data: {
          orderNumber: orders[0].orderNumber,
          materialName: 'Chip A15',
          required: 100,
          available: 45,
          shortage: 55,
        },
        link: `/production/orders/${orders[0].id}`,
        resourceType: 'ProductionOrder',
        resourceId: orders[0].id,
        priority: 4,
        read: false,
        archived: false,
      });
    }

    // 2. NOTIFICA√á√ÉO CR√çTICA - Taxa de Refugo Alta
    if (orders.length > 1) {
      notifications.push({
        userId: user.id,
        type: 'ERROR',
        category: 'QUALITY',
        eventType: 'QUALITY_SCRAP_HIGH',
        title: 'Taxa de Refugo Cr√≠tica',
        message: `OP ${orders[1].orderNumber} registrou 8.5% de refugo (limite: 5%). Investiga√ß√£o necess√°ria.`,
        data: {
          orderNumber: orders[1].orderNumber,
          scrapRate: 8.5,
          maxScrapRate: 5,
          scrapQty: 17,
          goodQty: 200,
        },
        link: `/production/orders/${orders[1].id}`,
        resourceType: 'ProductionOrder',
        resourceId: orders[1].id,
        priority: 4,
        read: false,
        archived: false,
      });
    }

    // 3. NOTIFICA√á√ÉO ALTA - Ordem Atrasada
    if (orders.length > 0) {
      notifications.push({
        userId: user.id,
        type: 'WARNING',
        category: 'PRODUCTION',
        eventType: 'PRODUCTION_DELAYED',
        title: 'Ordem de Produ√ß√£o Atrasada',
        message: `OP ${orders[0].orderNumber} (${orders[0].product.name}) est√° atrasada em 3 dias`,
        data: {
          orderNumber: orders[0].orderNumber,
          productName: orders[0].product.name,
          delayDays: 3,
        },
        link: `/production/orders/${orders[0].id}`,
        resourceType: 'ProductionOrder',
        resourceId: orders[0].id,
        priority: 3,
        read: false,
        archived: false,
      });
    }

    // 4. NOTIFICA√á√ÉO ALTA - Gargalo Detectado
    if (workCenters.length > 0) {
      notifications.push({
        userId: user.id,
        type: 'WARNING',
        category: 'PRODUCTION',
        eventType: 'BOTTLENECK_DETECTED',
        title: 'Gargalo Detectado',
        message: `Centro de trabalho "${workCenters[0].name}" possui 8 opera√ß√µes na fila`,
        data: {
          workCenterId: workCenters[0].id,
          workCenterName: workCenters[0].name,
          queueSize: 8,
          threshold: 5,
        },
        link: `/work-centers/${workCenters[0].id}`,
        resourceType: 'WorkCenter',
        resourceId: workCenters[0].id,
        priority: 3,
        read: false,
        archived: false,
      });
    }

    // 5. NOTIFICA√á√ÉO ALTA - Estoque Baixo
    if (products.length > 0) {
      notifications.push({
        userId: user.id,
        type: 'WARNING',
        category: 'STOCK',
        eventType: 'STOCK_BELOW_SAFETY',
        title: 'Estoque Abaixo do M√≠nimo',
        message: `${products[0].name}: 15 unidades (m√≠nimo: 50 unidades)`,
        data: {
          productCode: products[0].code,
          productName: products[0].name,
          currentStock: 15,
          minStock: 50,
        },
        link: `/stock/products/${products[0].id}`,
        resourceType: 'Product',
        resourceId: products[0].id,
        priority: 3,
        read: false,
        archived: false,
      });
    }

    // 6. NOTIFICA√á√ÉO M√âDIA - Opera√ß√£o Conclu√≠da
    if (orders.length > 2) {
      notifications.push({
        userId: user.id,
        type: 'SUCCESS',
        category: 'PRODUCTION',
        eventType: 'OPERATION_COMPLETED',
        title: 'Opera√ß√£o Conclu√≠da',
        message: `${user.name} concluiu opera√ß√£o de Montagem da OP ${orders[2].orderNumber}`,
        data: {
          orderNumber: orders[2].orderNumber,
          operationName: 'Montagem',
          operatorName: user.name,
          goodQty: 100,
          scrapQty: 2,
        },
        link: `/production/orders/${orders[2].id}`,
        resourceType: 'ProductionOrder',
        resourceId: orders[2].id,
        priority: 2,
        read: true, // J√° lida
        readAt: new Date(Date.now() - 2 * 60 * 60 * 1000), // 2 horas atr√°s
        archived: false,
      });
    }

    // 7. NOTIFICA√á√ÉO M√âDIA - Capacidade Baixa
    if (workCenters.length > 1) {
      notifications.push({
        userId: user.id,
        type: 'INFO',
        category: 'CAPACITY',
        eventType: 'CAPACITY_LOW',
        title: 'Capacidade Reduzida',
        message: `${workCenters[1].name} operando a 65% da capacidade`,
        data: {
          workCenterId: workCenters[1].id,
          workCenterName: workCenters[1].name,
          capacityPercent: 65,
        },
        link: `/work-centers/${workCenters[1].id}`,
        resourceType: 'WorkCenter',
        resourceId: workCenters[1].id,
        priority: 2,
        read: false,
        archived: false,
      });
    }

    // 8. NOTIFICA√á√ÉO BAIXA - Informativa (j√° lida e arquivada)
    if (products.length > 1) {
      notifications.push({
        userId: user.id,
        type: 'INFO',
        category: 'STOCK',
        eventType: 'STOCK_MOVEMENT',
        title: 'Entrada de Material',
        message: `Recebimento de ${products[1].name}: 500 unidades`,
        data: {
          productName: products[1].name,
          quantity: 500,
          type: 'IN',
        },
        link: `/stock/products/${products[1].id}`,
        resourceType: 'Product',
        resourceId: products[1].id,
        priority: 1,
        read: true,
        readAt: new Date(Date.now() - 24 * 60 * 60 * 1000), // 1 dia atr√°s
        archived: true,
        archivedAt: new Date(Date.now() - 12 * 60 * 60 * 1000), // 12 horas atr√°s
      });
    }

    // 9. NOTIFICA√á√ÉO CR√çTICA - Estoque Zerado
    if (products.length > 2) {
      notifications.push({
        userId: user.id,
        type: 'ERROR',
        category: 'STOCK',
        eventType: 'STOCK_BELOW_SAFETY',
        title: 'Estoque Zerado',
        message: `${products[2].name}: 0 unidades dispon√≠veis. Produ√ß√£o pode parar!`,
        data: {
          productCode: products[2].code,
          productName: products[2].name,
          currentStock: 0,
          minStock: 100,
        },
        link: `/stock/products/${products[2].id}`,
        resourceType: 'Product',
        resourceId: products[2].id,
        priority: 4,
        read: false,
        archived: false,
      });
    }

    // 10. NOTIFICA√á√ÉO ALTA - Pedido de Compra Aprovado
    notifications.push({
      userId: user.id,
      type: 'SUCCESS',
      category: 'PURCHASE',
      eventType: 'PURCHASE_ORDER_APPROVED',
      title: 'Pedido de Compra Aprovado',
      message: `Pedido PC-2025-0156 no valor de R$ 45.890,00 foi aprovado`,
      data: {
        orderNumber: 'PC-2025-0156',
        value: 45890.00,
        supplier: 'TechSupply Ltda',
      },
      link: `/purchases/orders`,
      resourceType: 'PurchaseOrder',
      resourceId: 'temp-id',
      priority: 2,
      read: false,
      archived: false,
    });

    // 11. NOTIFICA√á√ÉO M√âDIA - Manuten√ß√£o Programada
    if (workCenters.length > 0) {
      notifications.push({
        userId: user.id,
        type: 'WARNING',
        category: 'CAPACITY',
        eventType: 'MAINTENANCE_SCHEDULED',
        title: 'Manuten√ß√£o Programada',
        message: `${workCenters[0].name} ter√° manuten√ß√£o preventiva amanh√£ √†s 14h`,
        data: {
          workCenterId: workCenters[0].id,
          workCenterName: workCenters[0].name,
          scheduledDate: new Date(Date.now() + 24 * 60 * 60 * 1000),
        },
        link: `/work-centers/${workCenters[0].id}`,
        resourceType: 'WorkCenter',
        resourceId: workCenters[0].id,
        priority: 2,
        read: false,
        archived: false,
      });
    }

    // 12. NOTIFICA√á√ÉO ALTA - Meta de Produ√ß√£o Atingida
    if (orders.length > 1) {
      notifications.push({
        userId: user.id,
        type: 'SUCCESS',
        category: 'PRODUCTION',
        eventType: 'PRODUCTION_GOAL_ACHIEVED',
        title: 'Meta de Produ√ß√£o Atingida',
        message: `Parab√©ns! Meta mensal de 5.000 unidades foi atingida com 3 dias de anteced√™ncia`,
        data: {
          goal: 5000,
          achieved: 5234,
          percentage: 104.68,
        },
        link: `/reports`,
        resourceType: 'Report',
        resourceId: 'monthly-goal',
        priority: 1,
        read: false,
        archived: false,
      });
    }
  }

  // Criar notifica√ß√µes no banco
  console.log(`üìù Criando ${notifications.length} notifica√ß√µes...\n`);

  let created = 0;
  for (const notification of notifications) {
    await prisma.notification.create({
      data: notification,
    });
    created++;
    
    const icon = notification.priority === 4 ? 'üî¥' : 
                 notification.priority === 3 ? '‚ö†Ô∏è' : 
                 notification.priority === 2 ? 'üìä' : 'üìã';
    
    console.log(`${icon} ${notification.title} (${notification.category}) - Prioridade ${notification.priority}`);
  }

  console.log(`\n‚úÖ ${created} notifica√ß√µes criadas com sucesso!\n`);

  // Estat√≠sticas
  const stats = await prisma.notification.groupBy({
    by: ['priority'],
    _count: true,
  });

  console.log('üìä Estat√≠sticas:');
  stats.forEach(stat => {
    const label = stat.priority === 4 ? 'Cr√≠ticas' :
                  stat.priority === 3 ? 'Altas' :
                  stat.priority === 2 ? 'M√©dias' : 'Baixas';
    console.log(`   ${label}: ${stat._count}`);
  });

  const unreadCount = await prisma.notification.count({
    where: { read: false },
  });

  console.log(`   N√£o lidas: ${unreadCount}`);
  console.log(`   Total: ${created}\n`);
}

main()
  .catch((e) => {
    console.error('‚ùå Erro ao criar notifica√ß√µes:', e);
    process.exit(1);
  })
  .finally(async () => {
    await prisma.$disconnect();
  });
